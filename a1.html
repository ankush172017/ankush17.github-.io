using UnityEngine;

// Zaroori Components automatically add ho jayenge
[RequireComponent(typeof(CharacterController))]
public class IronHarborController : MonoBehaviour
{
    [Header("--- Player Statistics ---")]
    public float health = 100f;
    public int wantedLevel = 0; // 0 to 5 Stars
    public string currentZone = "District A: The Stacks";

    [Header("--- Movement Settings ---")]
    public float walkSpeed = 4.0f;
    public float runSpeed = 8.0f;
    public float jumpHeight = 1.5f;
    public float gravity = -19.62f;

    [Header("--- Camera Settings ---")]
    public Transform cameraTransform; // Main Camera ko yahan drag karein
    public float mouseSensitivity = 2.0f;
    public float lookXLimit = 60.0f;

    [Header("--- Interaction ---")]
    public float interactRange = 4.0f;
    public LayerMask interactableLayer; // Cars/Items ki layer

    // Private Variables (Logic ke liye)
    private CharacterController characterController;
    private Vector3 moveDirection = Vector3.zero;
    private float rotationX = 0;
    private bool canMove = true;
    private bool isInVehicle = false;

    void Start()
    {
        characterController = GetComponent<CharacterController>();

        // Mouse cursor ko hide aur lock karein (FPS/TPS feel ke liye)
        Cursor.lockState = CursorLockMode.Locked;
        Cursor.visible = false;
    }

    void Update()
    {
        if (isInVehicle)
        {
            HandleVehicleInput();
        }
        else
        {
            HandleOnFootMovement();
            HandleMouseLook();
            HandleInteraction();
        }

        // Test: Press 'P' to increase Wanted Level (Police Chase Simulation)
        if (Input.GetKeyDown(KeyCode.P))
        {
            IncreaseWantedLevel();
        }
    }

    // 1. CHARACTER MOVEMENT LOGIC
    void HandleOnFootMovement()
    {
        if (!canMove) return;

        // Ground check
        bool isGrounded = characterController.isGrounded;
        if (isGrounded && moveDirection.y < 0)
        {
            moveDirection.y = -2f;
        }

        // Input commands
        Vector3 forward = transform.TransformDirection(Vector3.forward);
        Vector3 right = transform.TransformDirection(Vector3.right);

        // Shift key se sprint karein
        bool isRunning = Input.GetKey(KeyCode.LeftShift);
        float curSpeedX = (isRunning ? runSpeed : walkSpeed) * Input.GetAxis("Vertical");
        float curSpeedY = (isRunning ? runSpeed : walkSpeed) * Input.GetAxis("Horizontal");

        float movementDirectionY = moveDirection.y;
        moveDirection = (forward * curSpeedX) + (right * curSpeedY);

        // Jump Logic
        if (Input.GetButton("Jump") && isGrounded)
        {
            moveDirection.y = Mathf.Sqrt(jumpHeight * -2f * gravity);
        }
        else
        {
            moveDirection.y = movementDirectionY;
        }

        // Gravity Apply karein
        moveDirection.y += gravity * Time.deltaTime;
        characterController.Move(moveDirection * Time.deltaTime);
    }

    // 2. CAMERA / MOUSE LOOK LOGIC
    void HandleMouseLook()
    {
        if (!canMove) return;

        rotationX += -Input.GetAxis("Mouse Y") * mouseSensitivity;
        rotationX = Mathf.Clamp(rotationX, -lookXLimit, lookXLimit);
        
        // Camera ko up/down rotate karein
        if(cameraTransform != null)
        {
            cameraTransform.localRotation = Quaternion.Euler(rotationX, 0, 0);
        }
        
        // Player body ko left/right rotate karein
        transform.rotation *= Quaternion.Euler(0, Input.GetAxis("Mouse X") * mouseSensitivity, 0);
    }

    // 3. INTERACTION SYSTEM (Entering Cars)
    void HandleInteraction()
    {
        // Screen ke center se Raycast phenkna
        Ray ray = new Ray(cameraTransform.position, cameraTransform.forward);
        RaycastHit hit;

        if (Physics.Raycast(ray, out hit, interactRange))
        {
            // Agar saamne gaadi hai (Tag 'Vehicle' hona chahiye)
            if (hit.collider.CompareTag("Vehicle"))
            {
                // UI Message Simulation (Debug Log)
                Debug.Log("Press [F] to hijack " + hit.collider.name);

                if (Input.GetKeyDown(KeyCode.F))
                {
                    EnterVehicle(hit.collider.gameObject);
                }
            }
        }
    }

    // 4. VEHICLE LOGIC (Simplified)
    void EnterVehicle(GameObject vehicle)
    {
        isInVehicle = true;
        // Character ko disable karein aur gaadi ko control karein
        Debug.Log("Entered Vehicle. Switching control...");
        // Real game mein yahan camera switch aur animation play hogi
    }

    void HandleVehicleInput()
    {
        // Agar gaadi mein hai, to 'F' dabane par bahar nikle
        if (Input.GetKeyDown(KeyCode.F))
        {
            isInVehicle = false;
            Debug.Log("Exited Vehicle.");
        }
    }

    // 5. WANTED LEVEL SYSTEM (Police AI Placeholder)
    void IncreaseWantedLevel()
    {
        wantedLevel++;
        if (wantedLevel > 5) wantedLevel = 5;
        
        string policeResponse = "";
        switch (wantedLevel)
        {
            case 1: policeResponse = "Patrol Drones Deployed"; break;
            case 2: policeResponse = "Police Units Pursuing"; break;
            case 3: policeResponse = "Roadblocks & SWAT"; break;
            case 4: policeResponse = "Tactical Eraser Squads"; break;
            case 5: policeResponse = "CITY LOCKDOWN - MILITARY"; break;
        }
        Debug.LogWarning("WANTED LEVEL " + wantedLevel + ": " + policeResponse);
    }

    // 6. DEBUG UI (Screen par status dikhane ke liye)
    void OnGUI()
    {
        GUIStyle style = new GUIStyle();
        style.fontSize = 20;
        style.normal.textColor = Color.white;

        GUI.Label(new Rect(20, 20, 300, 50), "Iron Harbor: Syndicate (Pre-Alpha)", style);
        
        style.normal.textColor = Color.yellow;
        GUI.Label(new Rect(20, 50, 300, 50), "Zone: " + currentZone, style);
        
        if(wantedLevel > 0)
        {
            style.normal.textColor = Color.red;
            GUI.Label(new Rect(20, 80, 300, 50), "WANTED LEVEL: " + wantedLevel + " â˜…", style);
        }

        if(isInVehicle)
        {
            style.normal.textColor = Color.cyan;
            GUI.Label(new Rect(Screen.width/2 - 50, Screen.height - 100, 200, 50), "DRIVING MODE", style);
        }
    }
}
